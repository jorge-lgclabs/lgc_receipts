<!-- Page Header-->
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Receipt Uploader - LGCLabs</title>
        <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='assets/favicon.ico') }}" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet" />
    </head>

  <div class="container position-relative px-4 px-lg-5">
    <div class="row gx-4 gx-lg-5 justify-content-center">
      <div class="col-md-10 col-lg-8 col-xl-7">
        <div class="page-heading">
          <h1>Store receipts on cloud storage</h1>
          <span class="subheading">Upload a photo of the receipt and fill out the appropriate information.</span>
             {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                <ul class=flashes>
                    {% for category, message in messages %}
                        <li class="{{ category }}">{{ message }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                {% endwith %}
                {% block body %}{% endblock %}
        </div>
      </div>
    </div>
  </div>

<!-- Main Content-->
<main class="mb-4">
  <div class="container px-4 px-lg-5">
    <div class="row gx-4 gx-lg-5 justify-content-center">
      <div class="col-md-10 col-lg-8 col-xl-7">
        <div class="my-5">
          <form
            id="uploadForm"
            name="uploadReceipt"
            action="/"
            method="post"
            enctype=multipart/form-data
          >
              <img id="preview" alt="image preview will go here once loaded" style="width:0%; height:0%; object-fit:contain; visibility:hidden;" onload="this.style.visibility='visible'; this.style.width='65%'; this.style.height='65%';" />
              <div class="form-floating">
                  <h5>Select photo file: </h5>
                <input type="file" id="photo" name="photo">
              </div>
            <div class="form-floating">
              <input
                class="form-control"
                id="entered_date"
                name="entered_date"
                type="date"
                required
              />
              <label for="entered_date">Date *</label>
            <div class="form-floating">
              <input
                class="form-control"
                id="name"
                name="name"
                type="text"
                placeholder="Enter name of vendor..."
                required
              />
              <label for="name">Vendor *</label>
            </div>
            <div class="form-floating">
              <input
                class="form-control"
                id="amount"
                name="amount"
                type="number"
                step="0.01"
                placeholder="Enter transaction amount..."
                required
              />
              <label for="amount">Amount *</label>
            </div>
            <div class="form-floating">
                <h5>Select a category: *</h5>
                <select id="category" name="category">
                    <option value="Meal">Meal</option>
                    <option value="Travel">Travel</option>
                    <option value="Supplies">Supplies</option>
                    <option value="Expense">Business Expense</option>
                </select>
            </div>
            <h3>* Required Field</h3>
            <button
              class="btn btn-primary text-uppercase"
              id="submitButton"
              type="submit"
            >
              Submit
            </button>
            </div>
          </form>
            <script>
                const fileInput = document.getElementById('photo');
                const form = document.getElementById('uploadForm');
                const preview = document.getElementById('preview');

                fileInput.addEventListener('change', async e => {

                    const file = e.target.files[0];
                    if (!file) return;

                    // only allow .jpg, .jpeg or .png
                    const validExts = ['jpg', 'jpeg', 'png'];
                    const name    = file.name.toLowerCase();
                    const ext     = name.slice(name.lastIndexOf('.') + 1);

                    if (!validExts.includes(ext)) {
                        alert('please only upload image file');
                        e.target.value = '';   // clear the input
                        return;
                    }
                    preview.src = URL.createObjectURL(file);
                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const res = await fetch('/pre-process', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await res.text();
                        if (!res.ok) return;
                        const date = data;
                        // console.log(date);

                        const dateField = document.getElementById('entered_date');;

                        if (date == 'null') {
                            dateField.value = new Date().toISOString().slice(0, 10);
                        } else {
                            dateField.value = date;
                        }}
                     catch (err) {
                     status.textContent = 'Error: ' + err.message;
                     }

                });
              </script>
        </div>
      </div>
    </div>
  </div>
</main>

